MooTools.More={version:"1.6.0",build:"45b71db70f879781a7e0b0d3fb3bb1307c2521eb"};Class.refactor=function(a,b){Object.each(b,function(d,e){var f=a.prototype[e];f=f&&f.$origin||f||function(){};a.implement(e,typeof d=="function"?function(){var g=this.previous;this.previous=f;var j=d.apply(this,arguments);this.previous=g;return j}:d)});return a};
(function(){Events.Pseudos=function(d,e,f){var g=function(h){return{store:h.store?function(k,l){h.store("_monitorEvents:"+k,l)}:function(k,l){(h._monitorEvents||(h._monitorEvents={}))[k]=l},retrieve:h.retrieve?function(k,l){return h.retrieve("_monitorEvents:"+k,l)}:function(k,l){if(!h._monitorEvents)return l;return h._monitorEvents[k]||l}}},j=function(h){if(h.indexOf(":")==-1||!d)return null;for(var k=Slick.parse(h).expressions[0][0],l=k.pseudos,m=l.length,n=[];m--;){var o=l[m].key,q=d[o];q!=null&&
n.push({event:k.tag,value:l[m].value,pseudo:o,original:h,listener:q})}return n.length?n:null};return{addEvent:function(h,k,l){var m=j(h);if(!m)return e.call(this,h,k,l);var n=g(this),o=n.retrieve(h,[]),q=m[0].event,r=Array.slice(arguments,2),s=k,v=this;m.each(function(t){var u=t.listener,w=s;if(u==false)q+=":"+t.pseudo+"("+t.value+")";else s=function(){u.call(v,t,w,arguments,s)}});o.include({type:q,event:k,monitor:s});n.store(h,o);h!=q&&e.apply(this,[h,k].concat(r));return e.apply(this,[q,s].concat(r))},
removeEvent:function(h,k){if(!j(h))return f.call(this,h,k);var l=g(this),m=l.retrieve(h);if(!m)return this;var n=Array.slice(arguments,2);f.apply(this,[h,k].concat(n));m.each(function(o,q){if(!k||o.event==k)f.apply(this,[o.type,o.monitor].concat(n));delete m[q]},this);l.store(h,m);return this}}};var a={once:function(d,e,f,g){e.apply(this,f);this.removeEvent(d.event,g).removeEvent(d.original,e)},throttle:function(d,e,f){if(!e._throttled){e.apply(this,f);e._throttled=setTimeout(function(){e._throttled=
false},d.value||250)}},pause:function(d,e,f){clearTimeout(e._pause);e._pause=e.delay(d.value||250,this,f)}};Events.definePseudo=function(d,e){a[d]=e;return this};Events.lookupPseudo=function(d){return a[d]};var b=Events.prototype;Events.implement(Events.Pseudos(a,b.addEvent,b.removeEvent));["Request","Fx"].each(function(d){this[d]&&this[d].implement(Events.prototype)})})();
(function(){var a=this.Drag=new Class({Implements:[Events,Options],options:{snap:6,unit:"px",grid:false,style:true,limit:false,handle:false,invert:false,unDraggableTags:["button","input","a","textarea","select","option"],preventDefault:false,stopPropagation:false,compensateScroll:false,modifiers:{x:"left",y:"top"}},initialize:function(){var b=Array.link(arguments,{options:Type.isObject,element:function(d){return d!=null}});this.element=document.id(b.element);this.document=this.element.getDocument();
this.setOptions(b.options||{});b=typeOf(this.options.handle);this.handles=(b=="array"||b=="collection"?$$(this.options.handle):document.id(this.options.handle))||this.element;this.mouse={now:{},pos:{}};this.value={start:{},now:{}};this.offsetParent=function(d){d=d.getOffsetParent();return!d||/^(?:body|html)$/i.test(d.tagName)?window:document.id(d)}(this.element);this.selection="selectstart"in document?"selectstart":"mousedown";this.compensateScroll={start:{},diff:{},last:{}};if("ondragstart"in document&&
!("FileReader"in window)&&!a.ondragstartFixed){document.ondragstart=Function.convert(false);a.ondragstartFixed=true}this.bound={start:this.start.bind(this),check:this.check.bind(this),drag:this.drag.bind(this),stop:this.stop.bind(this),cancel:this.cancel.bind(this),eventStop:Function.convert(false),scrollListener:this.scrollListener.bind(this)};this.attach()},attach:function(){this.handles.addEvent("mousedown",this.bound.start);this.handles.addEvent("touchstart",this.bound.start);this.options.compensateScroll&&
this.offsetParent.addEvent("scroll",this.bound.scrollListener);return this},detach:function(){this.handles.removeEvent("mousedown",this.bound.start);this.handles.removeEvent("touchstart",this.bound.start);this.options.compensateScroll&&this.offsetParent.removeEvent("scroll",this.bound.scrollListener);return this},scrollListener:function(){if(this.mouse.start){var b=this.offsetParent.getScroll();if(this.element.getStyle("position")=="absolute")this.mouse.now=this.sumValues(this.mouse.now,this.sumValues(b,
this.compensateScroll.last,-1),1);else this.compensateScroll.diff=this.sumValues(b,this.compensateScroll.start,-1);if(this.offsetParent!=window)this.compensateScroll.diff=this.sumValues(this.compensateScroll.start,b,-1);this.compensateScroll.last=b;this.render(this.options)}},sumValues:function(b,d,e){var f={},g=this.options,j;for(j in g.modifiers)if(g.modifiers[j])f[j]=b[j]+d[j]*e;return f},start:function(b){if(!this.options.unDraggableTags.contains(b.target.get("tag"))){var d=this.options;if(!b.rightClick){d.preventDefault&&
b.preventDefault();d.stopPropagation&&b.stopPropagation();this.compensateScroll.start=this.compensateScroll.last=this.offsetParent.getScroll();this.compensateScroll.diff={x:0,y:0};this.mouse.start=b.page;this.fireEvent("beforeStart",this.element);var e=d.limit;this.limit={x:[],y:[]};var f,g,j=this.offsetParent==window?null:this.offsetParent;for(f in d.modifiers)if(d.modifiers[f]){var h=this.element.getStyle(d.modifiers[f]);if(h&&!h.match(/px$/)){g||(g=this.element.getCoordinates(j));h=g[d.modifiers[f]]}this.value.now[f]=
d.style?(h||0).toInt():this.element[d.modifiers[f]];if(d.invert)this.value.now[f]*=-1;this.mouse.pos[f]=b.page[f]-this.value.now[f];if(e&&e[f])for(h=2;h--;){var k=e[f][h];if(k||k===0)this.limit[f][h]=typeof k=="function"?k():k}}if(typeOf(this.options.grid)=="number")this.options.grid={x:this.options.grid,y:this.options.grid};b={mousemove:this.bound.check,mouseup:this.bound.cancel,touchmove:this.bound.check,touchend:this.bound.cancel};b[this.selection]=this.bound.eventStop;this.document.addEvents(b)}}},
check:function(b){this.options.preventDefault&&b.preventDefault();if(Math.round(Math.sqrt(Math.pow(b.page.x-this.mouse.start.x,2)+Math.pow(b.page.y-this.mouse.start.y,2)))>this.options.snap){this.cancel();this.document.addEvents({mousemove:this.bound.drag,mouseup:this.bound.stop,touchmove:this.bound.drag,touchend:this.bound.stop});this.fireEvent("start",[this.element,b]).fireEvent("snap",this.element)}},drag:function(b){var d=this.options;d.preventDefault&&b.preventDefault();this.mouse.now=this.sumValues(b.page,
this.compensateScroll.diff,-1);this.render(d);this.fireEvent("drag",[this.element,b])},render:function(b){for(var d in b.modifiers)if(b.modifiers[d]){this.value.now[d]=this.mouse.now[d]-this.mouse.pos[d];if(b.invert)this.value.now[d]*=-1;if(b.limit&&this.limit[d])if((this.limit[d][1]||this.limit[d][1]===0)&&this.value.now[d]>this.limit[d][1])this.value.now[d]=this.limit[d][1];else if((this.limit[d][0]||this.limit[d][0]===0)&&this.value.now[d]<this.limit[d][0])this.value.now[d]=this.limit[d][0];if(b.grid[d])this.value.now[d]-=
(this.value.now[d]-(this.limit[d][0]||0))%b.grid[d];if(b.style)this.element.setStyle(b.modifiers[d],this.value.now[d]+b.unit);else this.element[b.modifiers[d]]=this.value.now[d]}},cancel:function(b){this.document.removeEvents({mousemove:this.bound.check,mouseup:this.bound.cancel,touchmove:this.bound.check,touchend:this.bound.cancel});if(b){this.document.removeEvent(this.selection,this.bound.eventStop);this.fireEvent("cancel",this.element)}},stop:function(b){var d={mousemove:this.bound.drag,mouseup:this.bound.stop,
touchmove:this.bound.drag,touchend:this.bound.stop};d[this.selection]=this.bound.eventStop;this.document.removeEvents(d);this.mouse.start=null;b&&this.fireEvent("complete",[this.element,b])}})})();Element.implement({makeResizable:function(a){var b=new Drag(this,Object.merge({modifiers:{x:"width",y:"height"}},a));this.store("resizer",b);return b.addEvent("drag",function(){this.fireEvent("resize",b)}.bind(this))}});
Drag.Move=new Class({Extends:Drag,options:{droppables:[],container:false,precalculate:false,includeMargins:true,checkDroppables:true},initialize:function(a,b){this.parent(a,b);a=this.element;this.droppables=$$(this.options.droppables);this.setContainer(this.options.container);if(this.options.style){if(this.options.modifiers.x=="left"&&this.options.modifiers.y=="top"){var d=a.getOffsetParent(),e=a.getStyles("left","top");if(d&&(e.left=="auto"||e.top=="auto"))a.setPosition(a.getPosition(d))}a.getStyle("position")==
"static"&&a.setStyle("position","absolute")}this.addEvent("start",this.checkDroppables,true);this.overed=null},setContainer:function(a){if((this.container=document.id(a))&&typeOf(this.container)!="element")this.container=document.id(this.container.getDocument().body)},start:function(a){if(this.container)this.options.limit=this.calculateLimit();if(this.options.precalculate)this.positions=this.droppables.map(function(b){return b.getCoordinates()});this.parent(a)},calculateLimit:function(){var a=this.element,
b=this.container,d=document.id(a.getOffsetParent())||document.body,e=b.getCoordinates(d),f={},g={},j={},h={},k=d.getScroll();["top","right","bottom","left"].each(function(o){f[o]=a.getStyle("margin-"+o).toInt();a.getStyle("border-"+o).toInt();g[o]=b.getStyle("margin-"+o).toInt();j[o]=b.getStyle("border-"+o).toInt();h[o]=d.getStyle("padding-"+o).toInt()},this);var l=0+k.x,m=0+k.y,n=e.right-j.right-(a.offsetWidth+f.left+f.right)+k.x;k=e.bottom-j.bottom-(a.offsetHeight+f.top+f.bottom)+k.y;if(this.options.includeMargins){l+=
f.left;m+=f.top}else{n+=f.right;k+=f.bottom}if(a.getStyle("position")=="relative"){e=a.getCoordinates(d);e.left-=a.getStyle("left").toInt();e.top-=a.getStyle("top").toInt();l-=e.left;m-=e.top;if(b.getStyle("position")!="relative"){l+=j.left;m+=j.top}n+=f.left-e.left;k+=f.top-e.top;if(b!=d){l+=g.left+h.left;if(!h.left&&l<0)l=0;m+=d==document.body?0:g.top+h.top;if(!h.top&&m<0)m=0}}else{l-=f.left;m-=f.top;if(b!=d){l+=e.left+j.left;m+=e.top+j.top}}return{x:[l,n],y:[m,k]}},getDroppableCoordinates:function(a){var b=
a.getCoordinates();if(a.getStyle("position")=="fixed"){a=window.getScroll();b.left+=a.x;b.right+=a.x;b.top+=a.y;b.bottom+=a.y}return b},checkDroppables:function(){var a=this.droppables.filter(function(b,d){b=this.positions?this.positions[d]:this.getDroppableCoordinates(b);var e=this.mouse.now;return e.x>b.left&&e.x<b.right&&e.y<b.bottom&&e.y>b.top},this).getLast();if(this.overed!=a){this.overed&&this.fireEvent("leave",[this.element,this.overed]);a&&this.fireEvent("enter",[this.element,a]);this.overed=
a}},drag:function(a){this.parent(a);this.options.checkDroppables&&this.droppables.length&&this.checkDroppables()},stop:function(a){this.checkDroppables();this.fireEvent("drop",[this.element,this.overed,a]);this.overed=null;return this.parent(a)}});Element.implement({makeDraggable:function(a){a=new Drag.Move(this,a);this.store("dragger",a);return a}});
Class.Mutators.Binds=function(a){this.prototype.initialize||this.implement("initialize",function(){});return Array.convert(a).concat(this.prototype.Binds||[])};Class.Mutators.initialize=function(a){return function(){Array.convert(this.Binds).each(function(b){var d=this[b];if(d)this[b]=d.bind(this)},this);return a.apply(this,arguments)}};
(function(){var a=function(d,e){var f=[];Object.each(e,function(g){Object.each(g,function(j){d.each(function(h){f.push(h+"-"+j+(h=="border"?"-width":""))})})});return f},b=function(d,e){var f=0;Object.each(e,function(g,j){if(j.test(d))f+=g.toInt()});return f};Element.implement({measure:function(d){if(!this||this.offsetHeight||this.offsetWidth)return d.call(this);for(var e=this.getParent(),f=[];!(!e||e.offsetHeight||e.offsetWidth)&&e!=document.body;){f.push(e.expose());e=e.getParent()}e=this.expose();
d=d.call(this);e();f.each(function(g){g()});return d},expose:function(){if(this.getStyle("display")!="none")return function(){};var d=this.style.cssText;this.setStyles({display:"block",position:"absolute",visibility:"hidden"});return function(){this.style.cssText=d}.bind(this)},getDimensions:function(d){d=Object.merge({computeSize:false},d);var e={x:0,y:0},f=this.getParent("body");if(f&&this.getStyle("display")=="none")e=this.measure(function(){return d.computeSize?this.getComputedSize(d):this.getSize()});
else if(f)try{e=d.computeSize?this.getComputedSize(d):this.getSize()}catch(g){}return Object.append(e,e.x||e.x===0?{width:e.x,height:e.y}:{x:e.width,y:e.height})},getComputedSize:function(d){d=Object.merge({styles:["padding","border"],planes:{height:["top","bottom"],width:["left","right"]},mode:"both"},d);var e={},f={width:0,height:0},g;if(d.mode=="vertical"){delete f.width;delete d.planes.width}else if(d.mode=="horizontal"){delete f.height;delete d.planes.height}a(d.styles,d.planes).each(function(j){e[j]=
this.getStyle(j).toInt()},this);Object.each(d.planes,function(j,h){var k=h.capitalize(),l=this.getStyle(h);if(l=="auto"&&!g)g=this.getDimensions();l=e[h]=l=="auto"?g[h]:l.toInt();f["total"+k]=l;j.each(function(m){var n=b(m,e);f["computed"+m.capitalize()]=n;f["total"+k]+=n})},this);return Object.append(f,e)}})})();
(function(){this.Slider=new Class({Implements:[Events,Options],Binds:["clickedElement","draggedKnob","scrolledElement"],options:{onTick:function(a){this.setKnobPosition(a)},initialStep:0,snap:false,offset:0,range:false,wheel:false,steps:100,mode:"horizontal"},initialize:function(a,b,d){this.setOptions(d);d=this.options;this.element=document.id(a);b=this.knob=document.id(b);this.previousChange=this.previousEnd=this.step=d.initialStep?d.initialStep:d.range?d.range[0]:0;a={};var e={x:false,y:false};
switch(d.mode){case "vertical":this.axis="y";this.property="top";this.offset="offsetHeight";break;case "horizontal":this.axis="x";this.property="left";this.offset="offsetWidth"}this.setSliderDimensions();this.setRange(d.range,null,true);b.getStyle("position")=="static"&&b.setStyle("position","relative");b.setStyle(this.property,-d.offset);e[this.axis]=this.property;a[this.axis]=[-d.offset,this.full-d.offset];a={snap:0,limit:a,modifiers:e,onDrag:this.draggedKnob,onStart:this.draggedKnob,onBeforeStart:function(){this.isDragging=
true}.bind(this),onCancel:function(){this.isDragging=false}.bind(this),onComplete:function(){this.isDragging=false;this.draggedKnob();this.end()}.bind(this)};d.snap&&this.setSnap(a);this.drag=new Drag(b,a);d.initialStep!=null&&this.set(d.initialStep,true);this.attach()},attach:function(){this.element.addEvent("mousedown",this.clickedElement);this.options.wheel&&this.element.addEvent("mousewheel",this.scrolledElement);this.drag.attach();return this},detach:function(){this.element.removeEvent("mousedown",
this.clickedElement).removeEvent("mousewheel",this.scrolledElement);this.drag.detach();return this},autosize:function(){this.setSliderDimensions().setKnobPosition(this.toPosition(this.step));this.drag.options.limit[this.axis]=[-this.options.offset,this.full-this.options.offset];this.options.snap&&this.setSnap();return this},setSnap:function(a){if(!a)a=this.drag.options;a.grid=Math.ceil(this.stepWidth);a.limit[this.axis][1]=this.element[this.offset];return this},setKnobPosition:function(a){if(this.options.snap)a=
this.toPosition(this.step);this.knob.setStyle(this.property,a);return this},setSliderDimensions:function(){this.full=this.element.measure(function(){this.half=this.knob[this.offset]/2;return this.element[this.offset]-this.knob[this.offset]+this.options.offset*2}.bind(this));return this},set:function(a,b){if(!(this.range>0^a<this.min))a=this.min;if(!(this.range>0^a>this.max))a=this.max;this.step=a.round(this.modulus.decimalLength);b?this.checkStep().setKnobPosition(this.toPosition(this.step)):this.checkStep().fireEvent("tick",
this.toPosition(this.step)).fireEvent("move").end();return this},setRange:function(a,b,d){this.min=Array.pick([a[0],0]);this.max=Array.pick([a[1],this.options.steps]);this.range=this.max-this.min;this.steps=this.options.steps||this.full;this.stepSize=Math.abs(this.range)/this.steps;this.stepWidth=this.stepSize*this.full/Math.abs(this.range);this.setModulus();a&&this.set(Array.pick([b,this.step]).limit(this.min,this.max),d);return this},setModulus:function(){for(var a=((this.stepSize+"").split(".")[1]||
[]).length,b="1";a--;)b+="0";this.modulus={multiplier:b.toInt(10),decimalLength:b.length-1}},clickedElement:function(a){if(!(this.isDragging||a.target==this.knob)){var b=this.range<0?-1:1;a=a.page[this.axis]-this.element.getPosition()[this.axis]-this.half;a=a.limit(-this.options.offset,this.full-this.options.offset);this.step=(this.min+b*this.toStep(a)).round(this.modulus.decimalLength);this.checkStep().fireEvent("tick",a).fireEvent("move").end()}},scrolledElement:function(a){this.set(this.step+((this.options.mode==
"horizontal"?a.wheel<0:a.wheel>0)?-1:1)*this.stepSize);a.stop()},draggedKnob:function(){var a=this.range<0?-1:1,b=this.drag.value.now[this.axis];b=b.limit(-this.options.offset,this.full-this.options.offset);this.step=(this.min+a*this.toStep(b)).round(this.modulus.decimalLength);this.checkStep();this.fireEvent("move")},checkStep:function(){var a=this.step;if(this.previousChange!=a){this.previousChange=a;this.fireEvent("change",a)}return this},end:function(){var a=this.step;if(this.previousEnd!==a){this.previousEnd=
a;this.fireEvent("complete",a+"")}return this},toStep:function(a){a=(a+this.options.offset)*this.stepSize/this.full*this.steps;return this.options.steps?(a-a*this.modulus.multiplier%(this.stepSize*this.modulus.multiplier)/this.modulus.multiplier).round(this.modulus.decimalLength):a},toPosition:function(a){return this.full*Math.abs(this.min-a)/(this.steps*this.stepSize)-this.options.offset||0}})})();
(function(){for(var a={relay:false},b=["once","throttle","pause"],d=b.length;d--;)a[b[d]]=Events.lookupPseudo(b[d]);DOMEvent.definePseudo=function(e,f){a[e]=f;return this};b=Element.prototype;[Element,Window,Document].invoke("implement",Events.Pseudos(a,b.addEvent,b.removeEvent))})();
Element.implement({isDisplayed:function(){return this.getStyle("display")!="none"},isVisible:function(){var a=this.offsetWidth,b=this.offsetHeight;return a==0&&b==0?false:a>0&&b>0?true:this.style.display!="none"},toggle:function(){return this[this.isDisplayed()?"hide":"show"]()},hide:function(){var a;try{a=this.getStyle("display")}catch(b){}if(a=="none")return this;return this.store("element:_originalDisplay",a||"").setStyle("display","none")},show:function(a){if(!a&&this.isDisplayed())return this;
a=a||this.retrieve("element:_originalDisplay")||"block";return this.setStyle("display",a=="none"?"block":a)},swapClass:function(a,b){return this.removeClass(a).addClass(b)}});Document.implement({clearSelection:function(){if(window.getSelection){var a=window.getSelection();a&&a.removeAllRanges&&a.removeAllRanges()}else if(document.selection&&document.selection.empty)try{document.selection.empty()}catch(b){}}});
(function(){var a=function(b){var d=b.options.hideInputs;if(window.OverText){var e=[null];OverText.each(function(f){e.include("."+f.options.labelClass)});if(e)d+=e.join(", ")}return d?b.element.getElements(d):null};Fx.Reveal=new Class({Extends:Fx.Morph,options:{link:"cancel",styles:["padding","border","margin"],transitionOpacity:"opacity"in document.documentElement,mode:"vertical",display:function(){return this.element.get("tag")!="tr"?"block":"table-row"},opacity:1,hideInputs:!("opacity"in document.documentElement)?
"select, input, textarea, object, embed":null},dissolve:function(){if(!this.hiding&&!this.showing)if(this.element.getStyle("display")!="none"){this.hiding=true;this.showing=false;this.hidden=true;this.cssText=this.element.style.cssText;var b=this.element.getComputedSize({styles:this.options.styles,mode:this.options.mode});if(this.options.transitionOpacity)b.opacity=this.options.opacity;var d={};Object.each(b,function(f,g){d[g]=[f,0]});this.element.setStyles({display:Function.convert(this.options.display).call(this),
overflow:"hidden"});var e=a(this);e&&e.setStyle("visibility","hidden");this.$chain.unshift(function(){if(this.hidden){this.hiding=false;this.element.style.cssText=this.cssText;this.element.setStyle("display","none");e&&e.setStyle("visibility","visible")}this.fireEvent("hide",this.element);this.callChain()}.bind(this));this.start(d)}else{this.callChain.delay(10,this);this.fireEvent("complete",this.element);this.fireEvent("hide",this.element)}else if(this.options.link=="chain")this.chain(this.dissolve.bind(this));
else if(this.options.link=="cancel"&&!this.hiding){this.cancel();this.dissolve()}return this},reveal:function(){if(!this.showing&&!this.hiding)if(this.element.getStyle("display")=="none"){this.hiding=false;this.showing=true;this.hidden=false;this.cssText=this.element.style.cssText;var b;this.element.measure(function(){b=this.element.getComputedSize({styles:this.options.styles,mode:this.options.mode})}.bind(this));if(this.options.heightOverride!=null)b.height=this.options.heightOverride.toInt();if(this.options.widthOverride!=
null)b.width=this.options.widthOverride.toInt();if(this.options.transitionOpacity){this.element.setStyle("opacity",0);b.opacity=this.options.opacity}var d={height:0,display:Function.convert(this.options.display).call(this)};Object.each(b,function(f,g){d[g]=0});d.overflow="hidden";this.element.setStyles(d);var e=a(this);e&&e.setStyle("visibility","hidden");this.$chain.unshift(function(){this.element.style.cssText=this.cssText;this.element.setStyle("display",Function.convert(this.options.display).call(this));
if(!this.hidden)this.showing=false;e&&e.setStyle("visibility","visible");this.callChain();this.fireEvent("show",this.element)}.bind(this));this.start(b)}else{this.callChain();this.fireEvent("complete",this.element);this.fireEvent("show",this.element)}else if(this.options.link=="chain")this.chain(this.reveal.bind(this));else if(this.options.link=="cancel"&&!this.showing){this.cancel();this.reveal()}return this},toggle:function(){this.element.getStyle("display")=="none"?this.reveal():this.dissolve();
return this},cancel:function(){this.parent.apply(this,arguments);if(this.cssText!=null)this.element.style.cssText=this.cssText;this.showing=this.hiding=false;return this}});Element.Properties.reveal={set:function(b){this.get("reveal").cancel().setOptions(b);return this},get:function(){var b=this.retrieve("reveal");if(!b){b=new Fx.Reveal(this);this.store("reveal",b)}return b}};Element.Properties.dissolve=Element.Properties.reveal;Element.implement({reveal:function(b){this.get("reveal").setOptions(b).reveal();
return this},dissolve:function(b){this.get("reveal").setOptions(b).dissolve();return this},nix:function(b){var d=Array.link(arguments,{destroy:Type.isBoolean,options:Type.isObject});this.get("reveal").setOptions(b).dissolve().chain(function(){this[d.destroy?"destroy":"dispose"]()}.bind(this));return this},wink:function(){var b=Array.link(arguments,{duration:Type.isNumber,options:Type.isObject}),d=this.get("reveal").setOptions(b.options);d.reveal().chain(function(){(function(){d.dissolve()}).delay(b.duration||
2E3)})}})})();
Fx.Elements=new Class({Extends:Fx.CSS,initialize:function(a,b){this.elements=this.subject=$$(a);this.parent(b)},compute:function(a,b,d){var e={},f;for(f in a){var g=a[f],j=b[f],h=e[f]={},k;for(k in g)h[k]=this.parent(g[k],j[k],d)}return e},set:function(a){for(var b in a)if(this.elements[b]){var d=a[b],e;for(e in d)this.render(this.elements[b],e,d[e],this.options.unit)}return this},start:function(a){if(!this.check(a))return this;var b={},d={},e;for(e in a)if(this.elements[e]){var f=a[e],g=b[e]={},
j=d[e]={},h;for(h in f){var k=this.prepare(this.elements[e],h,f[h]);g[h]=k.from;j[h]=k.to}}return this.parent(b,d)}});
Fx.Slide=new Class({Extends:Fx,options:{mode:"vertical",wrapper:false,hideOverflow:true,resetHeight:false},initialize:function(a,b){a=this.element=this.subject=document.id(a);this.parent(b);b=this.options;var d=a.retrieve("wrapper"),e=a.getStyles("margin","position","overflow");if(b.hideOverflow)e=Object.append(e,{overflow:"hidden"});if(b.wrapper)d=document.id(b.wrapper).setStyles(e);d||(d=(new Element("div",{styles:e})).wraps(a));a.store("wrapper",d).setStyle("margin",0);a.getStyle("overflow")==
"visible"&&a.setStyle("overflow","hidden");this.now=[];this.open=true;this.wrapper=d;this.addEvent("complete",function(){(this.open=d["offset"+this.layout.capitalize()]!=0)&&this.options.resetHeight&&d.setStyle("height","")},true)},vertical:function(){this.margin="margin-top";this.layout="height";this.offset=this.element.offsetHeight},horizontal:function(){this.margin="margin-left";this.layout="width";this.offset=this.element.offsetWidth},set:function(a){this.element.setStyle(this.margin,a[0]);this.wrapper.setStyle(this.layout,
a[1]);return this},compute:function(a,b,d){return[0,1].map(function(e){return Fx.compute(a[e],b[e],d)})},start:function(a,b){if(!this.check(a,b))return this;this[b||this.options.mode]();var d=this.element.getStyle(this.margin).toInt(),e=this.wrapper.getStyle(this.layout).toInt(),f=[[d,e],[0,this.offset]];d=[[d,e],[-this.offset,0]];var g;switch(a){case "in":g=f;break;case "out":g=d;break;case "toggle":g=e==0?f:d}return this.parent(g[0],g[1])},slideIn:function(a){return this.start("in",a)},slideOut:function(a){return this.start("out",
a)},hide:function(a){this[a||this.options.mode]();this.open=false;return this.set([-this.offset,0])},show:function(a){this[a||this.options.mode]();this.open=true;return this.set([0,this.offset])},toggle:function(a){return this.start("toggle",a)}});Element.Properties.slide={set:function(a){this.get("slide").cancel().setOptions(a);return this},get:function(){var a=this.retrieve("slide");if(!a){a=new Fx.Slide(this,{link:"cancel"});this.store("slide",a)}return a}};
Element.implement({slide:function(a,b){a=a||"toggle";var d=this.get("slide"),e;switch(a){case "hide":d.hide(b);break;case "show":d.show(b);break;case "toggle":e=this.retrieve("slide:flag",d.open);d[e?"slideOut":"slideIn"](b);this.store("slide:flag",!e);e=true;break;default:d.start(a,b)}e||this.eliminate("slide:flag");return this}});
(function(){this.Tips=new Class({Implements:[Events,Options],options:{onShow:function(){this.tip.setStyle("display","block")},onHide:function(){this.tip.setStyle("display","none")},title:"title",text:function(a){return a.get("rel")||a.get("href")},showDelay:100,hideDelay:100,className:"tip-wrap",offset:{x:16,y:16},windowPadding:{x:0,y:0},fixed:false,waiAria:true,hideEmpty:false},initialize:function(){var a=Array.link(arguments,{options:Type.isObject,elements:function(b){return b!=null}});this.setOptions(a.options);
a.elements&&this.attach(a.elements);this.container=new Element("div",{"class":"tip"});if(this.options.id){this.container.set("id",this.options.id);this.options.waiAria&&this.attachWaiAria()}},toElement:function(){if(this.tip)return this.tip;return this.tip=(new Element("div",{"class":this.options.className,styles:{position:"absolute",top:0,left:0,display:"none"}})).adopt(new Element("div",{"class":"tip-top"}),this.container,new Element("div",{"class":"tip-bottom"}))},attachWaiAria:function(){var a=
this.options.id;this.container.set("role","tooltip");if(!this.waiAria)this.waiAria={show:function(b){a&&b.set("aria-describedby",a);this.container.set("aria-hidden","false")},hide:function(b){a&&b.erase("aria-describedby");this.container.set("aria-hidden","true")}};this.addEvents(this.waiAria)},detachWaiAria:function(){if(this.waiAria){this.container.erase("role");this.container.erase("aria-hidden");this.removeEvents(this.waiAria)}},attach:function(a){$$(a).each(function(b){var d=this.options.title?
typeOf(this.options.title)=="function"?(0,this.options.title)(b):b.get(this.options.title):"",e=this.options.text?typeOf(this.options.text)=="function"?(0,this.options.text)(b):b.get(this.options.text):"";b.set("title","").store("tip:native",d).retrieve("tip:title",d);b.retrieve("tip:text",e);this.fireEvent("attach",[b]);d=["enter","leave"];this.options.fixed||d.push("move");d.each(function(f){var g=b.retrieve("tip:"+f);g||(g=function(j){this["element"+f.capitalize()].apply(this,[j,b])}.bind(this));
b.store("tip:"+f,g).addEvent("mouse"+f,g)},this)},this);return this},detach:function(a){$$(a).each(function(b){["enter","leave","move"].each(function(e){b.removeEvent("mouse"+e,b.retrieve("tip:"+e)).eliminate("tip:"+e)});this.fireEvent("detach",[b]);if(this.options.title=="title"){var d=b.retrieve("tip:native");d&&b.set("title",d)}},this);return this},elementEnter:function(a,b){clearTimeout(this.timer);this.timer=function(){this.container.empty();var d=!this.options.hideEmpty;["title","text"].each(function(e){var f=
b.retrieve("tip:"+e);e=this["_"+e+"Element"]=(new Element("div",{"class":"tip-"+e})).inject(this.container);if(f){this.fill(e,f);d=true}},this);d?this.show(b):this.hide(b);this.position(this.options.fixed?{page:b.getPosition()}:a)}.delay(this.options.showDelay,this)},elementLeave:function(a,b){clearTimeout(this.timer);this.timer=this.hide.delay(this.options.hideDelay,this,b);this.fireForParent(a,b)},setTitle:function(a){if(this._titleElement){this._titleElement.empty();this.fill(this._titleElement,
a)}return this},setText:function(a){if(this._textElement){this._textElement.empty();this.fill(this._textElement,a)}return this},fireForParent:function(a,b){b=b.getParent();!b||b==document.body||(b.retrieve("tip:enter")?b.fireEvent("mouseenter",a):this.fireForParent(a,b))},elementMove:function(a){this.position(a)},position:function(a){this.tip||document.id(this);var b=window.getSize(),d=window.getScroll(),e={x:this.tip.offsetWidth,y:this.tip.offsetHeight},f={x:"left",y:"top"},g={y:false,x2:false,y2:false,
x:false},j={},h;for(h in f){j[f[h]]=a.page[h]+this.options.offset[h];if(j[f[h]]<0)g[h]=true;if(j[f[h]]+e[h]-d[h]>b[h]-this.options.windowPadding[h]){j[f[h]]=a.page[h]-this.options.offset[h]-e[h];g[h+"2"]=true}}this.fireEvent("bound",g);this.tip.setStyles(j)},fill:function(a,b){typeof b=="string"?a.set("html",b):a.adopt(b)},show:function(a){this.tip||document.id(this);this.tip.getParent()||this.tip.inject(document.body);this.fireEvent("show",[this.tip,a])},hide:function(a){this.tip||document.id(this);
this.fireEvent("hide",[this.tip,a])}})})();var IIPMooViewer=new Class({Extends:Events,version:"2.0",initialize:function(a,b){this.source=a||alert("No element ID given to IIPMooViewer constructor");this.server=b.server||"/fcgi-bin/iipsrv.fcgi";this.render=b.render||"spiral";this.viewport=null;if(b.viewport)this.viewport={resolution:"resolution"in b.viewport?parseInt(b.viewport.resolution):null,rotation:"rotation"in b.viewport?parseInt(b.viewport.rotation):null,contrast:"contrast"in b.viewport?parseFloat(b.viewport.contrast):null,x:"x"in b.viewport?
parseFloat(b.viewport.x):null,y:"y"in b.viewport?parseFloat(b.viewport.y):null};else if(window.location.hash.length>0&&b.disableHash!=true){var d=window.location.hash.split("#")[1].split(",");if(c.length==3)this.viewport={x:parseFloat(d[0]),y:parseFloat(d[1]),resolution:parseInt(d[2])}}this.images=Array(b.image.length);b.image||alert("Image location not set in class constructor options");if(typeOf(b.image)=="array")for(i=0;i<b.image.length;i++)this.images[i]={src:b.image[i],sds:"0,90",cnt:this.viewport&&
this.viewport.contrast!=null?this.viewport.contrast:null,opacity:i==0?1:0};else this.images=[{src:b.image,sds:"0,90",cnt:this.viewport&&this.viewport.contrast!=null?this.viewport.contrast:null,shade:null}];this.loadoptions=b.load||null;this.credit=b.credit||null;this.scale=typeof Scale==="function"&&b.scale?new Scale(b.scale,b.units):null;this.enableFullscreen="native";if(typeof b.enableFullcreen!="undefined"){if(b.enableFullcreen==false)this.enableFullscreen=false;if(b.enableFullscreen=="page")this.enableFullscreen=
"page"}this.fullscreen=null;if(this.enableFullscreen!=false)this.fullscreen={isFullscreen:false,targetsize:{},eventChangeName:null,enter:null,exit:null};this.disableContextMenu=true;this.prefix=b.prefix||"images/";this.navigation=null;this.navOptions=b.navigation||null;if(typeof Navigation==="function")this.navigation=new Navigation({showNavWindow:b.showNavWindow,showNavButtons:b.showNavButtons,navWinSize:b.navWinSize,showCoords:b.showCoords,prefix:this.prefix,navigation:b.navigation});this.winResize=
typeof b.winResize!="undefined"&&b.winResize==false?false:true;switch(b.protocol){case "zoomify":this.protocol=new Protocols.Zoomify;break;case "deepzoom":this.protocol=new Protocols.DeepZoom;break;case "djatoka":this.protocol=new Protocols.Djatoka;break;case "IIIF":this.protocol=new Protocols.IIIF;break;default:this.protocol=new Protocols.IIP}this.preload=b.preload==true?true:false;this.effects=false;this.annotations=typeof this.initAnnotationTips=="function"&&b.annotations?b.annotations:null;this.click=
b.click||null;this.max_size={};this.hei=this.wid=0;this.resolutions=[];this.num_resolutions=0;this.view={x:0,y:0,w:this.wid,h:this.hei,res:0,rotation:0};this.tileSize={};this.tiles=[];this.nTilesToLoad=this.nTilesLoaded=0;this.CSSprefix="";if(Browser.name=="firefox")this.CSSprefix="-moz-";else if(Browser.name=="chrome"||Browser.name=="safari"||Browser.platform=="ios")this.CSSprefix="-webkit-";else if(Browser.name=="opera")this.CSSprefix="-o-";else if(Browser.name=="ie")this.CSSprefix="ms-";var e=
this;Tips=new Class({Extends:Tips,show:function(f){this.tip||document.id(this);this.tip.getParent()||this.tip.inject(document.id(e.source));this.fireEvent("show",[this.tip,f])}});window.addEvent("domready",this.load.bind(this))},requestImages:function(){this.canvas.setStyle("cursor","wait");if(!Browser.buggy){this.getView();this.canvas.setStyle(this.CSSprefix+"transform-origin",(this.wid>this.view.w?Math.round(this.view.x+this.view.w/2):Math.round(this.wid/2))+"px "+((this.hei>this.view.h?Math.round(this.view.y+
this.view.h/2):Math.round(this.hei/2))+"px"))}this.loadGrid();if(this.annotations){this.drawAnnotations();this.annotationTip&&this.annotationTip.attach(this.canvas.getChildren("div.annotation"))}},loadGrid:function(){var a=this.preload?1:0,b=this.getView(),d=Math.floor(b.x/this.tileSize.w)-a,e=Math.floor(b.y/this.tileSize.h)-a;if(d<0)d=0;if(e<0)e=0;var f=Math.min(this.wid,b.w),g=Math.ceil((f+b.x)/this.tileSize.w-1)+a;f=Math.min(this.hei,b.h);f=Math.ceil((f+b.y)/this.tileSize.h-1)+a;a=Math.ceil(this.wid/
this.tileSize.w);var j=Math.ceil(this.hei/this.tileSize.h);g=Math.min(g,a-1);f=Math.min(f,j-1);j=Math.floor(b.x%this.tileSize.w);if(this.wid<b.w)j-=(b.w-this.wid)/2;j=Math.floor(b.y%this.tileSize.h);if(this.hei<b.h)j-=(b.h-this.hei)/2;var h,k;k=b=0;k=d+Math.round((g-d)/2);var l=e+Math.round((f-e)/2);j=Array((g-d)*(g-d));var m=Array((g-d)*(g-d));m.empty();var n=0;for(h=e;h<=f;h++)for(e=d;e<=g;e++){j[n]={};j[n].n=this.render=="spiral"?Math.abs(l-h)*Math.abs(l-h)+Math.abs(k-e)*Math.abs(k-e):Math.random();
j[n].x=e;j[n].y=h;n++;b=e+h*a;m.push(b)}this.nTilesLoaded=0;this.nTilesToLoad=n*this.images.length;this.canvas.get("morph").cancel();var o=this;this.canvas.getChildren("img").each(function(q){var r=parseInt(q.retrieve("tile"));if(!m.contains(r)){q.destroy();o.tiles.erase(r)}});j.sort(function(q,r){return q.n-r.n});for(g=0;g<n;g++){e=j[g].x;h=j[g].y;b=e+h*a;if(this.tiles.contains(b)){this.nTilesLoaded+=this.images.length;this.navigation&&this.navigation.refreshLoadBar(this.nTilesLoaded,this.nTilesToLoad);
this.nTilesLoaded>=this.nTilesToLoad&&this.canvas.setStyle("cursor",null)}else for(k=0;k<this.images.length;k++){d=new Element("img",{"class":"layer"+k+" hidden",styles:{left:e*this.tileSize.w,top:h*this.tileSize.h}});this.effects&&d.setStyle("opacity",0.1);d.inject(this.canvas);f=this.protocol.getTileURL({server:this.server,image:this.images[k].src,resolution:this.view.res,sds:this.images[k].sds||"0,90",contrast:this.images[k].cnt||null,gamma:this.images[k].gam||null,shade:this.images[k].shade||
null,tileindex:b,x:e,y:h});d.addEvents({load:function(q,r){this.effects&&q.setStyle("opacity",1);q.removeClass("hidden");if(q.width&&q.height){this.nTilesLoaded++;this.navigation&&this.navigation.refreshLoadBar(this.nTilesLoaded,this.nTilesToLoad);this.nTilesLoaded>=this.nTilesToLoad&&this.canvas.setStyle("cursor",null);this.tiles.push(r)}else q.fireEvent("error")}.bind(this,d,b),error:function(){this.removeEvents("error");this.set("src",this.src+"?"+Date.now())}});d.set("src",f);d.store("tile",b);
this.images[k].opacity!==1&&this.canvas.getChildren("img.layer"+k).setStyle("opacity",this.images[k].opacity)}}},getRegionURL:function(){var a=this.resolutions[this.view.res].w,b=this.resolutions[this.view.res].h;return this.protocol.getRegionURL(this.server,this.images[0].src,{x:this.view.x/a,y:this.view.y/b,w:this.view.w/a,h:this.view.h/b},a,b)},key:function(a){var b=new DOMEvent(a),d=Math.round(this.view.w/4);switch(a.code){case 37:this.nudge(-d,0);IIPMooViewer.sync&&IIPMooViewer.windows(this).invoke("nudge",
-d,0);b.preventDefault();break;case 38:this.nudge(0,-d);IIPMooViewer.sync&&IIPMooViewer.windows(this).invoke("nudge",0,-d);b.preventDefault();break;case 39:this.nudge(d,0);IIPMooViewer.sync&&IIPMooViewer.windows(this).invoke("nudge",d,0);b.preventDefault();break;case 40:this.nudge(0,d);IIPMooViewer.sync&&IIPMooViewer.windows(this).invoke("nudge",0,d);b.preventDefault();break;case 107:if(!a.control){this.zoomIn();IIPMooViewer.sync&&IIPMooViewer.windows(this).invoke("zoomIn");b.preventDefault()}break;
case 109:case 189:if(!a.control){this.zoomOut();IIPMooViewer.sync&&IIPMooViewer.windows(this).invoke("zoomOut");b.preventDefault()}break;case 72:if(this.navOptions&&this.navOptions.id)break;b.preventDefault();this.navigation&&this.navigation.toggleWindow();this.credit&&this.container.getElement("div.credit").get("reveal").toggle();break;case 82:if(this.navOptions&&this.navOptions.buttons&&!this.navOptions.buttons.contains("rotateLeft")&&!this.navOptions.buttons.contains("rotateRight"))break;b.preventDefault();
if(!a.control){b=this.view.rotation;if(a.shift)b-=90;else b+=90;this.rotate(b);IIPMooViewer.sync&&IIPMooViewer.windows(this).invoke("rotate",b)}break;case 65:this.annotations&&this.toggleAnnotations();b.preventDefault();break;case 27:if(this.fullscreen&&this.fullscreen.isFullscreen)IIPMooViewer.sync||this.toggleFullScreen();this.container.getElement("div.info").fade("out");break;case 70:IIPMooViewer.sync||this.toggleFullScreen();b.preventDefault();break;case 67:a.control&&prompt("URL of current view:",
window.location.href.split("#")[0]+"#"+this.view.res+":"+(this.view.x+this.view.w/2)/this.wid+","+(this.view.y+this.view.h/2)/this.hei)}},rotate:function(a){if(!Browser.buggy){this.view.rotation=a;this.canvas.setStyle(this.CSSprefix+"transform","rotate("+a+"deg)");this.constrain();this.requestImages();this.updateNavigation()}},toggleFullScreen:function(){var a,b,d,e;if(this.enableFullscreen!=false){if(this.fullscreen.isFullscreen){a=this.fullscreen.targetsize.pos.x;b=this.fullscreen.targetsize.pos.y;
d=this.fullscreen.targetsize.size.x;e=this.fullscreen.targetsize.size.y;p=this.fullscreen.targetsize.position;this.fullscreen.exit&&this.fullscreen.exit.call(document)}else{this.fullscreen.targetsize={pos:{x:this.container.style.left,y:this.container.style.top},size:{x:this.container.style.width,y:this.container.style.height},position:this.container.style.position};b=a=0;e=d="100%";p="absolute";this.fullscreen.enter&&this.fullscreen.enter.call(this.container)}if(!this.fullscreen.enter){this.container.setStyles({left:a,
top:b,width:d,height:e,position:p});this.fullscreen.isFullscreen=!this.fullscreen.isFullscreen;this.fullscreen.isFullscreen?this.showPopUp(IIPMooViewer.lang.exitFullscreen):this.container.getElements("div.message").destroy();this.reload()}}},showPopUp:function(a){var b=(new Element("div",{"class":"message",html:a})).inject(this.container);(Browser.buggy?function(){b.destroy()}:function(){b.fade("out").get("tween").chain(function(){b.destroy()})}).delay(3E3)},scrollNavigation:function(a){this.canvas.get("morph").cancel();
var b=Math.round(a.x*this.wid);a=Math.round(a.y*this.hei);var d=Math.abs(b-this.view.x)<this.view.w/2&&Math.abs(a-this.view.y)<this.view.h/2&&this.view.rotation==0;this.view.x=b;this.view.y=a;if(d)this.canvas.morph({left:this.wid>this.view.w?-b:Math.round((this.view.w-this.wid)/2),top:this.hei>this.view.h?-a:Math.round((this.view.h-this.hei)/2)});else{this.positionCanvas();this.requestImages()}if(IIPMooViewer.sync){b=(b+this.view.w/2)/this.wid;a=(a+this.view.h/2)/this.hei;IIPMooViewer.windows(this).invoke("centerTo",
b,a)}},scroll:function(){var a={};a.x=this.canvas.getStyle("left").toInt();a.y=this.canvas.getStyle("top").toInt();var b=-a.x,d=-a.y,e=this.view.rotation%360;if(e<0)e+=360;if(e==90){b=this.view.x-(this.view.y+a.y);d=this.view.y+(this.view.x+a.x)}else if(e==180){b=this.view.x+(this.view.x+a.x);d=this.view.y+(this.view.y+a.y)}else if(e==270){b=this.view.x+(this.view.y+a.y);d=this.view.y-(this.view.x+a.x)}this.moveTo(b,d);if(IIPMooViewer.sync){a=(b+this.view.w/2)/this.wid;d=(d+this.view.h/2)/this.hei;
IIPMooViewer.windows(this).invoke("centerTo",a,d)}},getView:function(){var a=this.view.x,b=this.view.y,d=this.view.w,e=this.view.h;if(Math.abs(this.view.rotation%180)==90){a=Math.round(this.view.x+this.view.w/2-this.view.h/2);b=Math.round(this.view.y+this.view.h/2-this.view.w/2);if(a<0)a=0;if(b<0)b=0;d=this.view.h;e=this.view.w}return{x:a,y:b,w:d,h:e}},checkBounds:function(a,b){if(a>this.wid-this.view.w)a=this.wid-this.view.w;if(b>this.hei-this.view.h)b=this.hei-this.view.h;if(a<0||this.wid<this.view.w)a=
0;if(b<0||this.hei<this.view.h)b=0;this.view.x=a;this.view.y=b},moveTo:function(a,b){if(!(a==this.view.x&&b==this.view.y)){this.checkBounds(a,b);this.positionCanvas();this.requestImages();this.updateNavigation()}},centerTo:function(a,b){this.moveTo(Math.round(a*this.wid-this.view.w/2),Math.round(b*this.hei-this.view.h/2))},nudge:function(a,b){var d=a,e=b,f=this.view.rotation%360;if(f<0)f+=360;if(f==90){e=-a;d=b}else if(f==180){d=-a;e=-b}else if(f==270){d=-b;e=a}if(f==0){this.checkBounds(this.view.x+
d,this.view.y+e);this.canvas.morph({left:this.wid>this.view.w?-this.view.x:Math.round((this.view.w-this.wid)/2),top:this.hei>this.view.h?-this.view.y:Math.round((this.view.h-this.hei)/2)})}else this.moveTo(this.view.x+d,this.view.y+e);this.updateNavigation()},zoom:function(a){a=new DOMEvent(a);a.stop();var b=1;b=a.wheel&&a.wheel<0?-1:a.shift?-1:1;if(!(b==1&&this.view.res>=this.num_resolutions-1))if(!(b==-1&&this.view.res<=0)){if(a.target){var d;d=a.target.get("class");if(d!="zone"&d!="navimage"){d=
this.containerPosition;d={x:this.canvas.style.left.toInt()+d.x,y:this.canvas.style.top.toInt()+d.y};this.view.x=a.page.x-d.x-Math.floor(this.view.w/2);this.view.y=a.page.y-d.y-Math.floor(this.view.h/2)}else{d=this.navigation.zone.getParent().getPosition();var e=this.navigation.zone.getParent().getSize(),f=this.navigation.zone.getSize();this.view.x=Math.round((a.page.x-d.x-f.x/2)*this.wid/e.x);this.view.y=Math.round((a.page.y-d.y-f.y/2)*this.hei/e.y)}if(IIPMooViewer.sync){var g=(this.view.x+this.view.w/
2)/this.wid,j=(this.view.y+this.view.h/2)/this.hei;IIPMooViewer.windows(this).each(function(h){h.view.x=Math.round(g*h.wid-h.view.w/2);h.view.y=Math.round(j*h.hei-h.view.h/2)})}}b==-1?this.zoomOut():this.zoomIn();if(IIPMooViewer.sync)b==-1?IIPMooViewer.windows(this).invoke("zoomOut"):IIPMooViewer.windows(this).invoke("zoomIn")}},zoomIn:function(){this.view.res<this.num_resolutions-1&&this.zoomTo(this.view.res+1)},zoomOut:function(){this.view.res>0&&this.zoomTo(this.view.res-1)},zoomTo:function(a){if(a!=
this.view.res)if(a<=this.num_resolutions-1&&a>=0){var b=Math.pow(2,a-this.view.res),d,e;if(a>this.view.res){d=this.resolutions[this.view.res].w>this.view.w?this.view.w*(b-1)/2:this.resolutions[a].w/2-this.view.w/2;e=this.resolutions[this.view.res].h>this.view.h?this.view.h*(b-1)/2:this.resolutions[a].h/2-this.view.h/2}else{d=-this.view.w*(1-b)/2;e=-this.view.h*(1-b)/2}this.view.x=Math.round(b*this.view.x+d);this.view.y=Math.round(b*this.view.y+e);this.view.res=a;this._zoom()}},_zoom:function(){this.wid=
this.resolutions[this.view.res].w;this.hei=this.resolutions[this.view.res].h;if(this.view.x+this.view.w>this.wid)this.view.x=this.wid-this.view.w;if(this.view.x<0)this.view.x=0;if(this.view.y+this.view.h>this.hei)this.view.y=this.hei-this.view.h;if(this.view.y<0)this.view.y=0;this.positionCanvas();this.canvas.setStyles({width:this.wid,height:this.hei});this.constrain();this.canvas.getChildren("img").destroy();this.tiles.empty();this.requestImages();this.updateNavigation();this.navigation&&this.navigation.setCoords("");
this.scale&&this.scale.update(this.wid/this.max_size.w,this.view.w)},calculateNavSize:function(){var a=Math.round(this.view.w*this.navigation.options.navWinSize);if(this.max_size.w>2*this.max_size.h)a=Math.round(this.view.w/3);if(this.max_size.h/this.max_size.w*a>this.view.h*0.4)a=Math.round(this.view.h*0.4*this.max_size.w/this.max_size.h);this.navigation.size.x=a;this.navigation.size.y=Math.round(this.max_size.h/this.max_size.w*a);if(this.navOptions&&this.navOptions.id&&document.id(this.navOptions.id)){a=
document.id(this.navOptions.id).getSize();if(a.x<30)throw"Error: Navigation container is too small!";this.navigation.size.x=a.x;this.navigation.size.y=Math.round(this.max_size.h/this.max_size.w*a.x)}},updateContainerSize:function(){this.containerPosition=this.container.getPosition();var a=this.container.getSize();this.view.w=a.x;this.view.h=a.y},calculateSizes:function(){this.updateContainerSize();this.navigation&&this.calculateNavSize();this.view.res=this.num_resolutions;var a=this.max_size.w,b=
this.max_size.h;if(typeof this.resolutions=="undefined"){this.resolutions=Array(this.num_resolutions);this.resolutions.push({w:a,h:b});for(var d=1;d<this.num_resolutions;d++){a=Math.floor(a/2);b=Math.floor(b/2);this.resolutions.push({w:a,h:b})}this.resolutions.reverse()}this.view.res=0;for(d=this.num_resolutions-1;d>0;d--){a=this.resolutions[d].w;b=this.resolutions[d].h;if(a<this.view.w&&b<this.view.h){this.view.res=d;break}}if(this.view.res<0)this.view.res=0;if(this.view.res>=this.num_resolutions)this.view.res=
this.num_resolutions-1;this.wid=this.resolutions[this.view.res].w;this.hei=this.resolutions[this.view.res].h;this.scale&&this.scale.calculateDefault(this.max_size.w)},setCredit:function(a){this.container.getElement("div.credit").set("html",a)},createWindows:function(){this.container=document.id(this.source);this.container.addClass("iipmooviewer");var a=this;if(this.enableFullscreen=="native"){if(document.documentElement.requestFullscreen){this.fullscreen.eventChangeName="fullscreenchange";this.fullscreen.enter=
this.container.requestFullscreen;this.fullscreen.exit=document.cancelFullScreen}else if(document.mozCancelFullScreen){this.fullscreen.eventChangeName="mozfullscreenchange";this.fullscreen.enter=this.container.mozRequestFullScreen;this.fullscreen.exit=document.mozCancelFullScreen}else if(document.webkitCancelFullScreen){this.fullscreen.eventChangeName="webkitfullscreenchange";this.fullscreen.enter=this.container.webkitRequestFullScreen;this.fullscreen.exit=document.webkitCancelFullScreen}if(this.fullscreen.enter)document.addEventListener(this.fullscreen.eventChangeName,
function(){a.fullscreen.isFullscreen=!a.fullscreen.isFullscreen});else if(this.container.getStyle("width")=="100%"&&this.container.getStyle("height")=="100%")this.enableFullscreen=false}(new Element("div",{"class":"info",styles:{opacity:0},events:{click:function(){this.fade("out")}},html:'<div><div><h2><a href="http://iipimage.sourceforge.net"><img src="'+this.prefix+'iip.32x32.png"/></a>IIPMooViewer</h2>IIPImage HTML5 High Resolution Image Viewer - Version '+this.version+"<br/><ul><li>"+IIPMooViewer.lang.navigate+
"</li><li>"+IIPMooViewer.lang.zoomIn+"</li><li>"+IIPMooViewer.lang.zoomOut+"</li><li>"+IIPMooViewer.lang.rotate+"</li><li>"+IIPMooViewer.lang.fullscreen+"<li>"+IIPMooViewer.lang.annotations+"</li><li>"+IIPMooViewer.lang.navigation+"</li></ul><br/>"+IIPMooViewer.lang.more+' <a href="http://iipimage.sourceforge.net">http://iipimage.sourceforge.net</a></div></div>'})).inject(this.container);this.canvas=new Element("div",{"class":"canvas",morph:{transition:Fx.Transitions.Quad.easeInOut,onComplete:function(){a.requestImages()}}});
if("ontouchstart"in window||navigator.msMaxTouchPoints)this.addTouchEvents();else{var b=this.updateCoords.bind(this);this.touch=new Drag(this.canvas,{onStart:function(){a.canvas.addClass("drag");a.canvas.removeEvent("mousemove:throttle(75)",b)},onComplete:function(){a.scroll();a.canvas.removeClass("drag");a.canvas.addEvent("mousemove:throttle(75)",b)}})}this.canvas.inject(this.container);this.canvas.addEvents({"mousewheel:throttle(75)":this.zoom.bind(this),dblclick:this.zoom.bind(this),mousedown:function(g){(new DOMEvent(g)).stop()},
"mousemove:throttle(75)":b,mouseenter:function(){a.navigation&&a.navigation.coords&&a.navigation.coords.fade(0.65)},mouseleave:function(){a.navigation&&a.navigation.coords&&a.navigation.coords.fade("out")}});this.annotations&&this.initAnnotationTips();this.disableContextMenu&&this.container.addEvent("contextmenu",function(g){(new DOMEvent(g)).stop();a.container.getElement("div.info").fade(0.95);return false});if(this.click){var d=this.click.bind(this);this.canvas.addEvent("mouseup",d);this.touch&&
this.touch.addEvents({start:function(){a.canvas.removeEvents("mouseup")},complete:function(){a.canvas.addEvent("mouseup",d)}})}var e=this.key.bind(this);this.container.addEvents({mouseenter:function(){document.addEvent("keydown",e)},mouseleave:function(){document.removeEvent("keydown",e)},mousewheel:function(g){g.preventDefault()}});(new Element("img",{src:this.prefix+"iip.32x32.png","class":"logo",title:IIPMooViewer.lang.tooltips.help,events:{click:function(){a.container.getElement("div.info").fade(0.95)},
mousedown:function(g){(new DOMEvent(g)).stop()}}})).inject(this.container);Browser.platform=="ios"&&window.navigator.standalone&&this.container.addClass("standalone");this.credit&&(new Element("div",{"class":"credit",html:this.credit})).inject(this.container);this.scale&&this.scale.create(this.container);this.calculateSizes();if(this.navigation){this.navOptions&&this.navOptions.id&&document.id(this.navOptions.id)?this.navigation.create(document.id(this.navOptions.id)):this.navigation.create(this.container);
this.navigation.setImage(this.protocol.getThumbnailURL(this.server,this.images[0].src,this.navigation.size.x));this.navigation.addEvents({rotate:function(g){g=a.view.rotation+g;a.rotate(g);IIPMooViewer.sync&&IIPMooViewer.windows(a).invoke("rotate",g)},zoomIn:function(){a.zoomIn();IIPMooViewer.sync&&IIPMooViewer.windows(a).invoke("zoomIn")},zoomOut:function(){a.zoomOut();IIPMooViewer.sync&&IIPMooViewer.windows(a).invoke("zoomOut")},reload:function(){a.reload();IIPMooViewer.sync&&IIPMooViewer.windows(a).invoke("reload")},
scroll:this.scrollNavigation.bind(this),zoom:this.zoom.bind(this),print:this.print.bind(this)})}if(!(Browser.platform=="ios"||Browser.platform=="android")){var f="img.logo, div.toolbar, div.scale";if(Browser.name=="ie"&&(Browser.version==8||Browser.version==7))f="img.logo, div.toolbar";new Tips(f,{className:"tip",onShow:function(g){g.setStyles({opacity:0,display:"block"}).fade(0.9)},onHide:function(g){g.fade("out").get("tween").chain(function(){g.setStyle("display","none")})}})}if(this.viewport&&
"resolution"in this.viewport&&typeof this.resolutions[this.viewport.resolution]=="undefined")this.viewport.resolution=null;if(this.viewport&&this.viewport.resolution!=null){this.view.res=this.viewport.resolution;this.wid=this.resolutions[this.view.res].w;this.hei=this.resolutions[this.view.res].h;if(this.touch)this.touch.options.limit={x:[this.view.w-this.wid,0],y:[this.view.h-this.hei,0]}}this.viewport&&this.viewport.x!=null&&this.viewport.y!=null?this.centerTo(this.viewport.x,this.viewport.y):this.recenter();
this.canvas.setStyles({width:this.wid,height:this.hei});this.requestImages();this.updateNavigation();this.scale&&this.scale.update(this.wid/this.max_size.w,this.view.w);this.viewport&&this.viewport.rotation!=null&&this.rotate(this.viewport.rotation);"onhashchange"in window&&window.addEvent("hashchange",function(){var g=window.location.hash.split("#")[1].split(":");a.zoomTo(parseInt(g[0]));g=g.split(",");a.centerTo(parseFloat(g[0]),parseFloat(g[1]))});this.winResize&&window.addEvent("resize",this.reflow.bind(this));
this.fireEvent("load")},updateCoords:function(a){if(this.navigation&&this.navigation.coords)this.navigation.setCoords(this.transformCoords((a.page.x-this.containerPosition.x+this.view.x-(this.wid<this.view.w?Math.round((this.view.w-this.wid)/2):0))/this.wid,(a.page.y-this.containerPosition.y+this.view.y-(this.hei<this.view.h?Math.round((this.view.h-this.hei)/2):0))/this.hei))},transformCoords:function(a,b){return this.scale?Math.round(a*this.max_size.w/this.scale.pixelscale)+this.scale.units.dims[this.scale.defaultUnit]+
", "+Math.round(b*this.max_size.h/this.scale.pixelscale)+this.scale.units.dims[this.scale.defaultUnit]:Math.round(a*this.wid)+"px, "+Math.round(b*this.hei)+"px"},changeImage:function(a){this.images=[{src:a,sds:"0,90",cnt:this.viewport&&this.viewport.contrast!=null?this.viewport.contrast:null}];(new Request({method:"get",url:this.protocol.getMetaDataURL(this.server,this.images[0].src),onComplete:function(b){b=this.protocol.parseMetaData(b||alert("Error: No response from server "+this.server));this.max_size=
b.max_size;this.tileSize=b.tileSize;this.num_resolutions=b.num_resolutions;if(typeof this.resolutions!="undefined")this.resolutions=b.resolutions;this.reload();this.navigation&&this.navigation.setImage(this.protocol.getThumbnailURL(this.server,a,this.navigation.size.x));this.fireEvent("imageChanged")}.bind(this),onFailure:function(){alert("Error: Unable to get image metadata from server!")}})).send()},load:function(){if(this.loadoptions){this.max_size=this.loadoptions.size;this.tileSize=this.loadoptions.tiles;
this.num_resolutions=this.loadoptions.resolutions;this.createWindows()}else(new Request({method:"get",url:this.protocol.getMetaDataURL(this.server,this.images[0].src),onComplete:function(a){a=this.protocol.parseMetaData(a||alert("Error: No response from server "+this.server))||alert("Error: Unexpected response from server "+this.server);this.max_size=a.max_size;this.tileSize=a.tileSize;this.num_resolutions=a.num_resolutions;if(typeof this.resolutions!="undefined")this.resolutions=a.resolutions;this.createWindows()}.bind(this),
onFailure:function(){alert("Error: Unable to get image metadata from server!")}})).send()},reflow:function(){this.updateContainerSize();this.positionCanvas();if(this.navigation){this.calculateNavSize();this.navigation.reflow(this.container)}if(this.scale){this.scale.update(this.wid/this.max_size.w,this.view.w);this.scale.reflow(this.container)}this.requestImages();this.updateNavigation();this.constrain()},reload:function(){this.canvas.get("morph").cancel();this.canvas.getChildren("img").destroy();
this.tiles.empty();this.calculateSizes();if(this.viewport&&this.viewport.resolution!=null){this.view.res=this.viewport.resolution;this.wid=this.resolutions[this.view.res].w;this.hei=this.resolutions[this.view.res].h;if(this.touch)this.touch.options.limit={x:[this.view.w-this.wid,0],y:[this.view.h-this.hei,0]}}this.viewport&&this.viewport.x!=null&&this.viewport.y!=null?this.centerTo(this.viewport.x,this.viewport.y):this.recenter();if(typeof Scale==="function"&&this.viewport&&this.viewport.scale!=null&&
!this.scale)this.scale=new Scale(this.viewport.scale);this.canvas.setStyles({width:this.wid,height:this.hei});this.reflow();this.viewport&&this.viewport.rotation!=null?this.rotate(this.viewport.rotation):this.rotate(0)},recenter:function(){var a=Math.round((this.wid-this.view.w)/2);this.view.x=a<0?0:a;a=Math.round((this.hei-this.view.h)/2);this.view.y=a<0?0:a;this.positionCanvas();this.constrain()},constrain:function(){var a=this.wid<this.view.w?[Math.round((this.view.w-this.wid)/2),Math.round((this.view.w-
this.wid)/2)]:[this.view.w-this.wid,0],b=this.hei<this.view.h?[Math.round((this.view.h-this.hei)/2),Math.round((this.view.h-this.hei)/2)]:[this.view.h-this.hei,0];if(this.touch)this.touch.options.limit={x:a,y:b}},positionCanvas:function(){this.canvas.setStyles({left:this.wid>this.view.w?-this.view.x:Math.round((this.view.w-this.wid)/2),top:this.hei>this.view.h?-this.view.y:Math.round((this.view.h-this.hei)/2)})},updateNavigation:function(){if(this.navigation){var a=this.getView();this.navigation.update(a.x/
this.wid,a.y/this.hei,a.w/this.wid,a.h/this.hei)}},toggleNavigationWindow:function(){this.navigation&&this.navigation.toggleWindow()},print:function(){var a=this.resolutions[this.view.res].w,b=this.resolutions[this.view.res].h;a=this.protocol.getRegionURL(this.server,this.images[0].src,{x:this.view.x/a,y:this.view.y/b,w:this.view.w/a,h:this.view.h/b},1280,1754);window.open(a,"_blank").addEventListener("load",function(){this.focus();this.print();this.close()})}});
IIPMooViewer.synchronize=function(a){this.sync=a};IIPMooViewer.windows=function(a){if(!this.sync||!this.sync.contains(a))return[];return this.sync.filter(function(b){return b!=a})};Browser.buggy=Browser.name=="ie"&&(!Browser.version||Browser.version<9);Element.NativeEvents.hashchange=1;if(typeof Protocols==="undefined")var Protocols={};var Navigation=new Class({Extends:Events,options:{},position:{x:0,y:0},size:{x:0,y:0},initialize:function(a){this.options.showNavWindow=a.showNavWindow==false?false:true;this.options.showNavButtons=a.showNavButtons==false?false:true;this.options.navWinSize=a.navWinSize||0.2;this.options.showCoords=a.showCoords==true?true:false;this.prefix=a.prefix;this.standalone=a.navigation&&a.navigation.id&&document.id(a.navigation.id)?true:false;this.options.navButtons=a.navigation&&a.navigation.buttons||["reset",
"zoomIn","zoomOut"]},create:function(a){if(this.options.showNavWindow||this.options.showNavButtons){this.navcontainer=new Element("div",{"class":"navcontainer",styles:{width:this.size.x,position:this.standalone?"static":"absolute"}});if(!this.standalone){var b=new Element("div",{"class":"toolbar",events:{dblclick:function(j){j.getElement("div.navbuttons").get("slide").toggle()}.pass(a)}});b.store("tip:text",IIPMooViewer.lang.drag);b.inject(this.navcontainer)}if(this.options.showNavWindow){var d=new Element("div",
{"class":"navwin",styles:{height:this.size.y}});d.inject(this.navcontainer);(new Element("img",{"class":"navimage",events:{click:this.scroll.bind(this),"mousewheel:throttle(75)":function(j){g.fireEvent("zoom",j)},mousedown:function(j){(new DOMEvent(j)).stop()}}})).inject(d);this.zone=new Element("div",{"class":"zone",morph:{duration:500,transition:Fx.Transitions.Quad.easeInOut},events:{"mousewheel:throttle(75)":function(j){g.fireEvent("zoom",j)},dblclick:function(j){g.fireEvent("zoom",j)}},styles:{width:0,
height:0}});this.zone.inject(d);if(this.options.showCoords){this.coords=new Element("div",{"class":"coords",html:"<div></div>",styles:{top:this.size.y-6,opacity:0.8},tween:{duration:1E3,transition:Fx.Transitions.Sine.easeOut,link:"cancel"}});this.coords.inject(this.navcontainer)}}if(this.options.showNavButtons){var e=new Element("div",{"class":"navbuttons"}),f=this.prefix;this.options.navButtons.each(function(j){(new Element("img",{src:f+j+(Browser.buggy?".png":".svg"),"class":j,title:IIPMooViewer.lang.tooltips[j],
events:{error:function(){this.removeEvents("error");this.src=this.src.replace(".svg",".png")}}})).inject(e)});e.inject(this.navcontainer);e.set("slide",{duration:300,transition:Fx.Transitions.Quad.easeInOut,mode:"vertical"});var g=this;this.options.navButtons.contains("reset")&&e.getElement("img.reset").addEvent("click",function(){g.fireEvent("reload")});this.options.navButtons.contains("zoomIn")&&e.getElement("img.zoomIn").addEvent("click",function(){g.fireEvent("zoomIn")});this.options.navButtons.contains("zoomOut")&&
e.getElement("img.zoomOut").addEvent("click",function(){g.fireEvent("zoomOut")});this.options.navButtons.contains("rotateLeft")&&e.getElement("img.rotateLeft").addEvent("click",function(){g.fireEvent("rotate",-90)});this.options.navButtons.contains("rotateRight")&&e.getElement("img.rotateRight").addEvent("click",function(){g.fireEvent("rotate",90)});this.options.navButtons.contains("print")&&e.getElement("img.print").addEvent("click",function(){g.fireEvent("print")})}this.options.showNavWindow&&(new Element("div",
{"class":"loadBarContainer",html:'<div class="loadBar"></div>',styles:{width:this.size.x-2},tween:{duration:1E3,transition:Fx.Transitions.Sine.easeOut,link:"cancel"}})).inject(this.navcontainer);this.navcontainer.inject(a);this.options.showNavWindow&&this.zone.makeDraggable({container:this.navcontainer.getElement("div.navwin"),onStart:function(){var j=g.zone.getPosition();g.position={x:j.x,y:j.y-10};g.zone.get("morph").cancel()},onComplete:this.scroll.bind(this)});this.standalone||this.navcontainer.makeDraggable({container:a,
handle:b})}},toggleWindow:function(){this.navcontainer&&this.navcontainer.get("reveal").toggle()},refreshLoadBar:function(a,b){if(this.options.showNavWindow){var d=a/b*this.size.x,e=this.navcontainer.getElement("div.loadBarContainer"),f=e.getElement("div.loadBar");f.setStyle("width",d);f.set("html",IIPMooViewer.lang.loading+"&nbsp;:&nbsp;"+Math.round(a/b*100)+"%");e.style.opacity!="0.85"&&e.setStyles({visibility:"visible",opacity:0.85});a>=b&&e.fade("out")}},reflow:function(a){a.getElements("div.navcontainer, div.navcontainer div.loadBarContainer").setStyle("width",
this.size.x);if(this.options.showNavWindow){this.navcontainer&&this.navcontainer.setStyle("left",a.getPosition(a).x+a.getSize().x-this.size.x-10);this.zone&&this.zone.getParent().setStyle("height",this.size.y);this.options.showCoords&&this.coords.setStyle("top",this.size.y-6)}},setImage:function(a){if(this.navcontainer&&this.navcontainer.getElement("img.navimage"))this.navcontainer.getElement("img.navimage").src=a},setCoords:function(a){this.coords&&this.coords.getElement("div").set("html",a)},scroll:function(a){this.zone.get("morph").cancel();
var b=0,d=0;b=this.zone.getSize();var e=b.x,f=b.y;if(a.event){a.stop();d=this.zone.getParent().getPosition();b=a.page.x-d.x-Math.floor(e/2);d=a.page.y-d.y-Math.floor(f/2)}else{b=a.offsetLeft;d=a.offsetTop-10;if(Math.abs(b-this.position.x)<3&&Math.abs(d-this.position.y)<3)return}if(b>this.size.x-e)b=this.size.x-e;if(d>this.size.y-f)d=this.size.y-f;if(b<0)b=0;if(d<0)d=0;b/=this.size.x;d/=this.size.y;this.fireEvent("scroll",{x:b,y:d});a.event&&this.update(b,d,e/this.size.x,f/this.size.y)},update:function(a,
b,d,e){if(this.options.showNavWindow){a*=this.size.x;if(a>this.size.x)a=this.size.x;if(a<0)a=0;b*=this.size.y;if(b>this.size.y)b=this.size.y;if(b<0)b=0;d*=this.size.x;if(a+d>this.size.x)d=this.size.x-a;e*=this.size.y;if(e+b>this.size.y)e=this.size.y-b;var f=this.zone.offsetHeight-this.zone.clientHeight;this.zone.morph({fps:30,left:a,top:this.standalone?b:b+8,width:d-f>0?d-f:1,height:e-f>0?e-f:1})}}});var Scale=new Class({initialize:function(a,b){this.pixelscale=a;this.units={dims:["pm","nm","&#181;m","mm","cm","m","km"],orders:[1.0E-12,1.0E-9,1.0E-6,0.001,0.01,1,1E3],mults:[1,2,5,10,50,100],factor:1E3};if(b)if(instanceOf(b,String)==false)this.units=b;else if(b=="degrees")this.units={dims:["''","'","&deg"],orders:[1/3600,1/60,1],mults:[1,10,15,30],factor:3600}},create:function(a){this.scale=(new Element("div",{"class":"scale",title:IIPMooViewer.lang.scale,html:'<div class="ruler"></div><div class="label"></div>'})).inject(a);
this.scale.makeDraggable({container:a});this.scale.getElement("div.ruler").set("tween",{transition:Fx.Transitions.Quad.easeInOut})},update:function(a,b){var d=this.units.factor*this.pixelscale*a,e,f;e=0;a:for(;e<this.units.orders.length;e++)for(f=0;f<this.units.mults.length;f++)if(this.units.orders[e]*this.units.mults[f]*d>b/20)break a;if(e>=this.units.orders.length)e=this.units.orders.length-1;if(f>=this.units.mults.length)f=this.units.mults.length-1;var g=this.units.mults[f]+this.units.dims[e];
d=d*this.units.orders[e]*this.units.mults[f]-4;this.scale.getElement("div.ruler").tween("width",d);this.scale.getElement("div.label").set("html",g)},calculateDefault:function(a){for(var b=0;b<this.units.orders.length;b++)if(a/(this.units.orders[b]*this.units.factor*this.pixelscale)<1E3)break;this.defaultUnit=b},reflow:function(a){this.scale.setStyles({left:10,top:a.getSize().y-a.getElement("div.scale").getSize().y-10})}});IIPMooViewer.implement({addTouchEvents:function(){if("ontouchstart"in window||navigator.msMaxTouchPoints){var a=this;this.container.addEvent("touchmove",function(b){b.preventDefault()});document.body.addEvents({touchmove:function(b){b.preventDefault()},orientationchange:function(){a.container.setStyles({width:"100%",height:"100%"});this.reflow.delay(500,this)}.bind(this)});this.canvas.addEvents({touchstart:function(b){b.preventDefault();a.touchend=null;if(b.touches.length==1){var d=a.canvas.retrieve("taptime")||
0,e=Date.now();a.canvas.store("taptime",e);a.canvas.store("tapstart",1);if(e-d<250){a.canvas.eliminate("taptime");a.zoomIn();IIPMooViewer.sync&&IIPMooViewer.windows(a).invoke("zoomIn")}else{a.touchstart={x:b.touches[0].pageX,y:b.touches[0].pageY};a.canvas.addClass("drag")}}else if(b.touches.length==2){a.canvas.store("gesturestart",1);a.touchstart=[{x:b.touches[0].pageX,y:b.touches[0].pageY},{x:b.touches[1].pageX,y:b.touches[1].pageY}];a.canvas.setStyle(a.CSSprefix+"transform","translateZ(0,0,0)")}},
touchmove:function(b){if(b.touches.length==1){a.touchend={x:b.touches[0].pageX,y:b.touches[0].pageY};var d=a.touchend.x-a.touchstart.x,e=a.touchend.y-a.touchstart.y;d=a.view.x-d;e=a.view.y-e;if(d>a.wid-a.view.w)a.touchend.x=a.touchstart.x-a.wid+a.view.w+a.view.x;if(e>a.hei-a.view.h)a.touchend.y=a.touchstart.y-a.hei+a.view.h+a.view.y;if(d<0)a.touchend.x=a.touchstart.x+a.view.x;if(e<0)a.touchend.y=a.touchstart.y+a.view.y;d=a.wid>a.view.w?a.touchend.x-a.touchstart.x:0;e=a.hei>a.view.h?a.touchend.y-a.touchstart.y:
0;a.canvas.setStyle(a.CSSprefix+"transform","translate3d("+d+"px,"+e+"px, 0 )")}if(b.touches.length==2){a.touchend=[{x:b.touches[0].pageX,y:b.touches[0].pageY},{x:b.touches[1].pageX,y:b.touches[1].pageY}];a.canvas.setStyle(this.CSSprefix+"transform-origin",Math.round((b.touches[0].pageX+b.touches[1].pageX)/2)+a.view.x+"px,"+(Math.round((b.touches[0].pageY+b.touches[1].pageY)/2)+a.view.y)+"px")}},touchend:function(){if(a.canvas.retrieve("gesturestart")==1){a.canvas.removeClass("drag");a.canvas.eliminate("tapstart");
a.canvas.eliminate("gesturestart");var b=(a.touchend[1].x-a.touchend[0].x)*(a.touchend[1].x-a.touchend[0].x)+(a.touchend[1].y-a.touchend[0].y)*(a.touchend[1].y-a.touchend[0].y)-((a.touchstart[1].x-a.touchstart[0].x)*(a.touchstart[1].x-a.touchstart[0].x)+(a.touchstart[1].y-a.touchstart[0].y)*(a.touchstart[1].y-a.touchstart[0].y));if(Math.abs(b)>2E4)if(b>0){a.zoomIn();IIPMooViewer.sync&&IIPMooViewer.windows(a).invoke("zoomIn")}else{if(b<0){a.zoomOut();IIPMooViewer.sync&&IIPMooViewer.windows(a).invoke("zoomOut")}}else{b=
Math.atan2(a.touchend[1].y-a.touchend[0].y,a.touchend[1].x-a.touchend[0].x)*180/Math.PI-Math.atan2(a.touchstart[1].y-a.touchstart[0].y,a.touchstart[1].x-a.touchstart[0].x)*180/Math.PI;if(Math.abs(b)>25){var d=a.view.rotation;if(b>0)d+=90;else d-=90;a.rotate(d);IIPMooViewer.sync&&IIPMooViewer.windows(a).invoke("rotate",d)}}a.touchend=null}else if(a.canvas.retrieve("tapstart")==1&&a.touchend){a.canvas.eliminate("tapstart");a.view.x-=a.touchend.x-a.touchstart.x;a.view.y-=a.touchend.y-a.touchstart.y;
a.touchend=null;if(a.view.x>a.wid-a.view.w)a.view.x=a.wid-a.view.w;if(a.view.y>a.hei-a.view.h)a.view.y=a.hei-a.view.h;if(a.view.x<0)a.view.x=0;if(a.view.y<0)a.view.y=0;a.canvas.setStyle(a.CSSprefix+"transform","none");a.canvas.setStyles({left:a.wid>a.view.w?-a.view.x:Math.round((a.view.w-a.wid)/2),top:a.hei>a.view.h?-a.view.y:Math.round((a.view.h-a.hei)/2)});a.requestImages();a.navigation&&a.navigation.update(a.view.x/a.wid,a.view.y/a.hei,a.view.w/a.wid,a.view.h/a.hei);IIPMooViewer.sync&&IIPMooViewer.windows(a).invoke("moveTo",
a.view.x,a.view.y);a.canvas.setStyle(a.CSSprefix+"transform","translateZ(0)");a.canvas.removeClass("drag")}}})}}});Protocols.IIP=new Class({getMetaDataURL:function(a,b){var d=a+"?FIF="+b+"&obj=IIP,1.0&obj=Max-size&obj=Tile-size&obj=Resolution-number";if(this.ask_resolutions)d+="&obj=Resolutions";return d},getTileURL:function(a){var b=Array("?FIF="+a.image);a.contrast&&b.push("CNT="+a.contrast);a.sds&&b.push("SDS="+a.sds);a.rotation&&b.push("ROT="+a.rotation);a.gamma&&b.push("GAM="+a.gamma);a.shade&&b.push("SHD="+a.shade+",30");b.push("JTL="+a.resolution+","+a.tileindex);return a.server+b.join("&")},parseMetaData:function(a){var b=
a.split("Max-size");if(!b[1])return null;var d=b[1].split(" "),e={w:parseInt(d[0].substring(1,d[0].length)),h:parseInt(d[1])};b=a.split("Tile-size");if(!b[1])return null;d=b[1].split(" ");var f={w:parseInt(d[0].substring(1,d[0].length)),h:parseInt(d[1])};b=a.split("Resolution-number");d=parseInt(b[1].substring(1,b[1].length));e={max_size:e,tileSize:f,num_resolutions:d};if(this.ask_resolutions){b=a.split("Resolutions");b=b[1].substring(1,b[1].length);a=b.split(",");b=[];for(f=0;f<a.length;f++){var g=
a[f].split(" ");b.push({w:parseInt(g[0]),h:parseInt(g[1])})}if(b.length==d)e.resolutions=b}return e},getRegionURL:function(a,b,d,e,f){d=d.x+","+d.y+","+d.w+","+d.h;var g="";if(e)g+="&WID="+e;if(f)g+="&HEI="+f;return a+"?FIF="+b+g+"&RGN="+d+"&CVT=jpeg"},getThumbnailURL:function(a,b,d){return a+"?FIF="+b+"&WID="+d+"&QLT=98&CVT=jpeg"}});IIPMooViewer.implement({initAnnotationTips:function(){this.annotationTip=null;this.annotationsVisible=true;this.createAnnotationsArray();var a=this;this.canvas.addEvent("mouseenter",function(){a.annotationsVisible&&a.canvas.getElements("div.annotation").removeClass("hidden")});this.canvas.addEvent("mouseleave",function(){a.annotationsVisible&&a.canvas.getElements("div.annotation").addClass("hidden")})},createAnnotationsArray:function(){var a=[];Object.each(this.annotations,function(b,d){b.id=d;a.push(b)});
a.sort(function(b,d){return d.w*d.h-b.w*b.h});this.annotation_array=a},drawAnnotations:function(){if(this.annotations){for(var a,b=0,d=this.annotation_array.length;b<d;b++){a=this.annotation_array[b];var e={left:Math.round(this.wid*a.x),top:Math.round(this.hei*a.y),width:Math.round(this.wid*a.w),height:Math.round(this.hei*a.h)},f=$("annotation-"+a.id);f?f.setStyles(e):this.initAnnotation(a,e)}if(!this.annotationTip)this.annotationTip=this.createAnnotationsTips()}},initAnnotation:function(a,b){var d=
"annotation";if(a.category)d+=" "+a.category;d=(new Element("div",{id:"annotation-"+a.id,"class":d,styles:b})).inject(this.canvas);this.annotationsVisible||d.addClass("hidden");if(typeof this.editAnnotation=="function"){var e=this;d.addEvent("dblclick",function(g){(new DOMEvent(g)).stop();e.editAnnotation(this)})}var f=a.text;if(a.title)f="<h1>"+a.title+"</h1>"+f;d.store("tip:text",f)},createAnnotationsTips:function(){return new Tips("div.annotation",{className:"tip",fixed:true,offset:{x:30,y:30},
hideDelay:300,link:"chain",onShow:function(a){a.setStyles({opacity:a.getStyle("opacity"),display:"block"}).fade(0.9);a.addEvents({mouseleave:function(){this.active=false;this.fade("out").get("tween").chain(function(){this.element.setStyle("display","none")})},mouseenter:function(){this.active=true}})},onHide:function(a){if(!a.active){a.fade("out").get("tween").chain(function(){this.element.setStyle("display","none")});a.removeEvents(["mouseenter","mouseleave"])}}})},toggleAnnotations:function(){var a=
this.canvas.getElements("div.annotation");if(a)if(this.annotationsVisible){a.addClass("hidden");this.annotationsVisible=false;this.showPopUp(IIPMooViewer.lang.annotationsDisabled)}else{a.removeClass("hidden");this.annotationsVisible=true}},destroyAnnotations:function(){this.annotationTip&&this.annotationTip.detach(this.canvas.getChildren("div.annotation"));this.canvas.getChildren("div.annotation").each(function(a){a.eliminate("tip:text");a.destroy()})}});IIPMooViewer.implement({blend:function(a){this.addEvent("load",function(){this.images[1]={src:a[0][0],sds:"0,90",opacity:0};this.createBlendingInterface();a.each(function(b){(new Element("option",{value:b[0],html:b[1]})).inject(document.id("baselayer")).clone().inject(document.id("overlay"))})})},createBlendingInterface:function(){var a=this;(new Element("div",{"class":"blending",html:'<h2 title="<h2>Image Comparison</h2>Select the pair of images you wish<br/>to compare from the menus below.<br/>Use the slider to blend smoothly<br/>between them">Image Comparison</h2><span>Image 1</span><select id="baselayer"></select><br/><br/><span>Move slider to blend between images:</span><br/><div id="area"><div id="knob"></div></div><br/><span>Image 2</span><select id="overlay"></select><br/>'})).inject(this.navigation.navcontainer);
new Tips("div.blending h2",{className:"tip",onShow:function(d){d.setStyle("opacity",0);d.fade(0.7)},onHide:function(d){d.fade(0)}});var b=new Slider(document.id("area"),document.id("knob"),{range:[0,100],onChange:function(d){if(a.images[1]){a.images[1].opacity=d/100;a.canvas.getChildren("img.layer1").setStyle("opacity",a.images[1].opacity)}}});window.addEvent("resize",function(){b.autosize()});document.id("baselayer").addEvent("change",function(){a.images[0].src=document.id("baselayer").value;a.canvas.getChildren("img.layer0").destroy();
a.tiles.empty();a.requestImages()});document.id("overlay").addEvent("change",function(){var d=0;if(a.images[1])d=a.images[1].opacity;a.images[1]={src:document.id("overlay").value,opacity:d};a.canvas.getChildren("img.layer1").destroy();a.tiles.empty();a.requestImages()})}});IIPMooViewer.lang={scale:"draggable scale",navigate:"To navigate within image: drag image within main window or drag zone within the navigation window or click an area within navigation window",zoomIn:'To zoom in: double click or use the mouse scroll wheel or simply press the "+" key',zoomOut:'To zoom out: shift double click or use the mouse wheel or press the "-" key',rotate:'To rotate image clockwise: press the "r" key, anti-clockwise: press shift and "r"',fullscreen:'For fullscreen: press the "f" key',
annotations:'To toggle any annotations: press the "a" key',navigation:'To show/hide navigation window: press "h" key',more:"For more information visit",exitFullscreen:'Press "Esc" to exit fullscreen mode',loading:"loading",drag:"* Drag to move<br/>* Double Click to show/hide buttons<br/>* Press h to hide",annotationsDisabled:'Annotations disabled<br/>Press "a" to re-enable',tooltips:{help:"click for help",reset:"Reset View",zoomIn:"Zoom In",zoomOut:"Zoom Out",rotateLeft:"Rotate left",rotateRight:"Rotate right",
print:"Print View"}};
